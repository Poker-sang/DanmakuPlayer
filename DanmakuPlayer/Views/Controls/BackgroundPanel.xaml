<Grid
    x:Class="DanmakuPlayer.Views.Controls.BackgroundPanel"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:common="using:FluentIcons.Common"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:converters="using:DanmakuPlayer.Views.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:fluent="using:FluentIcons.WinUI"
    xmlns:local="using:DanmakuPlayer.Views.Controls"
    xmlns:markup="using:FluentIcons.WinUI.Markup"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:xaml="using:Microsoft.Graphics.Canvas.UI.Xaml"
    DoubleTapped="MaximizeRestoreDoubleTapped"
    Loaded="RootLoaded"
    PointerReleased="BackgroundPanelOnPointerPressed"
    SizeChanged="RootSizeChanged"
    Unloaded="RootUnloaded"
    mc:Ignorable="d">
    <Grid.Resources>
        <Color x:Key="TransparentColor">#CC000000</Color>
        <converters:DoubleToTimeTextConverter x:Key="DoubleToTimeTextConverter" />
    </Grid.Resources>
    <Grid.RowDefinitions>
        <RowDefinition x:Name="TopRow" Height="*" />
        <RowDefinition Height="4*" />
        <RowDefinition x:Name="BottomRow" Height="*" />
    </Grid.RowDefinitions>
    <local:WebView2ForVideo
        x:Name="WebView"
        Grid.Row="0"
        Grid.RowSpan="3"
        x:FieldModifier="public"
        IsHitTestVisible="{x:Bind local:C.Negation(Vm.LockWebView2), Mode=OneWay}"
        KeyboardAcceleratorPlacementMode="Hidden"
        Url="{x:Bind Vm.Url, Mode=TwoWay}"
        VideoLoaded="WebViewOnPageLoaded"
        Visibility="{x:Bind local:C.ToVisibility(Vm.EnableWebView2), Mode=OneWay}"
        Duration="{x:Bind Vm.Duration, Mode=TwoWay}" />
    <!--  留0.5px距离防止WebView2不渲染  -->
    <xaml:CanvasAnimatedControl
        x:Name="DanmakuCanvas"
        Grid.Row="0"
        Grid.RowSpan="3"
        Margin="0.5"
        CreateResources="DanmakuCanvasCreateResources"
        Draw="DanmakuCanvasDraw"
        IsHitTestVisible="False" />
    <local:WelcomePage Grid.Row="1" Visibility="{x:Bind local:C.WelcomePageVisibility(Vm.Url, Vm.EnableWebView2), Mode=OneWay}" />
    <StackPanel
        x:Name="InfoBarContainer"
        Grid.Row="0"
        Grid.RowSpan="3"
        Width="320"
        Margin="32,64"
        HorizontalAlignment="Left">
        <StackPanel.ChildrenTransitions>
            <TransitionCollection>
                <PaneThemeTransition Edge="Left" />
            </TransitionCollection>
        </StackPanel.ChildrenTransitions>
    </StackPanel>
    <local:CollapsibleArea
        Grid.Row="0"
        Canvas.ZIndex="2"
        IsActive="{x:Bind Vm.FullScreen, Mode=OneWay}">
        <Grid>
            <Grid.Background>
                <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,0.8">
                    <LinearGradientBrush.GradientStops>
                        <GradientStop Offset="0" Color="{StaticResource TransparentColor}" />
                        <GradientStop Offset="1" Color="#00000000" />
                    </LinearGradientBrush.GradientStops>
                </LinearGradientBrush>
            </Grid.Background>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Border
                Grid.Row="0"
                Grid.RowSpan="2"
                Grid.Column="0"
                Grid.ColumnSpan="3"
                Background="{ThemeResource SolidBackgroundFillColorQuarternaryBrush}"
                Visibility="{x:Bind local:C.ToVisibilityNegation(Vm.FullScreen), Mode=OneWay}" />

            <CommandBar
                Grid.Row="0"
                Grid.Column="0"
                DefaultLabelPosition="Right"
                OverflowButtonVisibility="Collapsed">
                <AppBarButton
                    x:Uid="/MainPanel/DownloadButton"
                    Click="ImportClick"
                    Icon="{markup:SymbolIcon Symbol=ArrowDownload}"
                    IsEnabled="{x:Bind local:C.Negation(Vm.LoadingDanmaku), Mode=OneWay}"
                    LabelPosition="Collapsed"
                    RightTapped="FileClick" />
                <AppBarButton
                    x:Uid="/MainPanel/RemoteButton"
                    Click="RemoteClick"
                    Label="{x:Bind DialogRemote.ConnectedCount, Mode=OneWay}"
                    LabelPosition="{x:Bind local:C.BoolToLabelVisibility(DialogRemote.IsConnected), Mode=OneWay}">
                    <AppBarButton.Icon>
                        <fluent:SymbolIcon IconVariant="{x:Bind local:C.ColorIconSelector(DialogRemote.IsConnected), Mode=OneWay}" Symbol="LinkMultiple" />
                    </AppBarButton.Icon>
                </AppBarButton>
            </CommandBar>
            <Grid
                Grid.Row="0"
                Grid.Column="1"
                Visibility="{x:Bind local:C.ToVisibility(Vm.EnableWebView2), Mode=OneWay}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <CommandBar Grid.Column="0" OverflowButtonVisibility="Collapsed">
                    <AppBarButton
                        x:Uid="/MainPanel/GoBackButton"
                        local:TapHelper.DoubleTappedDisabled="True"
                        Click="GoBackClick"
                        Icon="{markup:SymbolIcon Symbol=ArrowLeft}"
                        IsEnabled="{x:Bind WebView.CanGoBack, Mode=OneWay}" />
                </CommandBar>
                <AutoSuggestBox
                    x:Uid="/MainPanel/UriAutoSuggestBox"
                    Grid.Column="1"
                    VerticalAlignment="Center"
                    QueryIcon="{markup:SymbolIcon Symbol=Search,
                                                  FontSize=16}"
                    QuerySubmitted="AddressBoxOnQuerySubmitted"
                    Text="{x:Bind WebView.Url, Mode=OneWay}" />
            </Grid>
            <CommandBar
                Grid.Row="0"
                Grid.Column="2"
                OverflowButtonVisibility="Collapsed">
                <AppBarButton
                    x:Uid="/MainPanel/TopmostButton"
                    local:TapHelper.DoubleTappedDisabled="True"
                    Click="TopMostClick">
                    <AppBarButton.Icon>
                        <fluent:SymbolIcon Symbol="{x:Bind local:C.SymbolSelector(Vm.TopMost, common:Symbol.Pin, common:Symbol.PinOff), Mode=OneWay}" />
                    </AppBarButton.Icon>
                </AppBarButton>
                <AppBarButton
                    x:Uid="/MainPanel/SettingsButton"
                    Click="SettingClick"
                    Icon="{markup:SymbolIcon Symbol=Settings}">
                    <AppBarButton.KeyboardAccelerators>
                        <KeyboardAccelerator Key="Escape" />
                    </AppBarButton.KeyboardAccelerators>
                </AppBarButton>
                <AppBarButton x:Uid="/MainPanel/MaximizeButton" Click="MaximizeRestoreDoubleTapped">
                    <AppBarButton.Icon>
                        <fluent:SymbolIcon Symbol="{x:Bind local:C.SymbolSelector(Vm.IsMaximized, common:Symbol.SquareMultiple, common:Symbol.Square), Mode=OneWay}" />
                    </AppBarButton.Icon>
                </AppBarButton>
                <AppBarButton
                    x:Uid="/MainPanel/CloseButton"
                    Click="CloseClick"
                    Icon="{markup:SymbolIcon Symbol=Dismiss}">
                    <AppBarButton.Resources>
                        <!--  ReSharper disable once Xaml.RedundantResource  -->
                        <SolidColorBrush x:Key="AppBarButtonBackgroundPointerOver" Color="Red" />
                        <!--  ReSharper disable once Xaml.RedundantResource  -->
                        <SolidColorBrush x:Key="AppBarButtonBackgroundPressed" Color="DarkRed" />
                    </AppBarButton.Resources>
                </AppBarButton>
            </CommandBar>
        </Grid>
    </local:CollapsibleArea>
    <local:CollapsibleArea
        Grid.Row="2"
        Canvas.ZIndex="2"
        IsActive="{x:Bind Vm.FullScreen, Mode=OneWay}">
        <Grid>
            <Grid.Background>
                <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                    <LinearGradientBrush.GradientStops>
                        <GradientStop Offset="0" Color="#00000000" />
                        <GradientStop Offset="1" Color="{StaticResource TransparentColor}" />
                    </LinearGradientBrush.GradientStops>
                </LinearGradientBrush>
            </Grid.Background>
            <Border Background="{ThemeResource SolidBackgroundFillColorQuarternaryBrush}" Visibility="{x:Bind local:C.ToVisibilityNegation(Vm.FullScreen), Mode=OneWay}" />
            <controls:DockPanel LastChildFill="False">
                <controls:DockPanel controls:DockPanel.Dock="Bottom" LastChildFill="False">
                    <CommandBar controls:DockPanel.Dock="Left" OverflowButtonVisibility="Collapsed">
                        <AppBarButton
                            x:Uid="/MainPanel/RewindButton"
                            Width="40"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="RewindClick"
                            Icon="{markup:SymbolIcon Symbol=Rewind}"
                            RightTapped="RewindClick">
                            <AppBarButton.KeyboardAccelerators>
                                <KeyboardAccelerator Key="Left" />
                            </AppBarButton.KeyboardAccelerators>
                        </AppBarButton>
                        <AppBarButton
                            x:Uid="/MainPanel/PlayPauseButton"
                            Width="40"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="PauseResumeClick">
                            <AppBarButton.Icon>
                                <fluent:SymbolIcon Symbol="{x:Bind local:C.SymbolSelector(Vm.IsPlaying, common:Symbol.Pause, common:Symbol.Play), Mode=OneWay}" />
                            </AppBarButton.Icon>
                            <AppBarButton.KeyboardAccelerators>
                                <KeyboardAccelerator Key="Space" />
                            </AppBarButton.KeyboardAccelerators>
                        </AppBarButton>
                        <!--  KeyboardAccelerator会自动触发Click无法区分  -->
                        <AppBarButton
                            x:Uid="/MainPanel/FastForwardButton"
                            Width="40"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Icon="{markup:SymbolIcon Symbol=FastForward}"
                            RightTapped="FastForwardClick"
                            Tapped="FastForwardClick">
                            <AppBarButton.KeyboardAccelerators>
                                <KeyboardAccelerator Key="Right" Invoked="FastForwardClick" />
                            </AppBarButton.KeyboardAccelerators>
                        </AppBarButton>
                    </CommandBar>
                    <Grid
                        x:Uid="/MainPanel/TimeEditGrid"
                        Margin="10,0"
                        controls:DockPanel.Dock="Left"
                        Background="Transparent"
                        Tapped="TimeTextTapped">
                        <StackPanel
                            Margin="0"
                            Orientation="Horizontal"
                            Spacing="5"
                            Visibility="{x:Bind local:C.ToVisibilityNegation(Vm.EditingTime), Mode=OneWay}">
                            <TextBlock
                                VerticalAlignment="Center"
                                Text="{x:Bind local:C.ToTimeString(Vm.Time), Mode=OneWay}"
                                TextAlignment="Right" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Text="-"
                                TextAlignment="Center" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Text="{x:Bind local:C.ToTimeString(Vm.TotalTime), Mode=OneWay}"
                                TextAlignment="Left" />
                        </StackPanel>
                        <TextBox
                            x:Name="TimeText"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Center"
                            AcceptsReturn="False"
                            IsEnabled="{x:Bind Vm.EditingTime, Mode=OneWay}"
                            IsEnabledChanged="TimeTextIsEditing"
                            KeyboardAcceleratorPlacementMode="Hidden"
                            LostFocus="TimeTextLostFocus"
                            TextAlignment="Center"
                            Visibility="{x:Bind local:C.ToVisibility(Vm.EditingTime), Mode=OneWay}">
                            <TextBox.KeyboardAccelerators>
                                <KeyboardAccelerator Key="Enter" Invoked="TimeTextInvoked" />
                            </TextBox.KeyboardAccelerators>
                        </TextBox>
                    </Grid>
                    <CommandBar
                        controls:DockPanel.Dock="Left"
                        DefaultLabelPosition="Right"
                        OverflowButtonVisibility="Collapsed">
                        <AppBarButton
                            x:Uid="/MainPanel/TurnOffDanmakuButton"
                            Width="40"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="TurnOffDanmakuOnClick"
                            LabelPosition="Collapsed">
                            <AppBarButton.Icon>
                                <fluent:SymbolIcon Symbol="{x:Bind local:C.SymbolSelector(Vm.TurnOffDanmaku, common:Symbol.CommentOff, common:Symbol.Comment), Mode=OneWay}" />
                            </AppBarButton.Icon>
                        </AppBarButton>
                        <AppBarButton
                            x:Uid="/MainPanel/AdvanceDanmakuButton"
                            Width="40"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="AdvanceDanmakuClick"
                            Icon="{markup:SymbolIcon Symbol=ArrowReply}"
                            LabelPosition="Collapsed"
                            RightTapped="AdvanceDanmakuClick" />
                        <AppBarButton
                            x:Uid="/MainPanel/SyncDanmakuButton"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="SyncDanmakuClick"
                            Icon="{markup:SymbolIcon Symbol=ArrowRepeatAll}"
                            Label="{x:Bind Vm.DanmakuDelayTime.TotalSeconds, Mode=OneWay}" />
                        <AppBarButton
                            x:Uid="/MainPanel/DelayDanmakuButton"
                            Width="40"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="DelayDanmakuClick"
                            Icon="{markup:SymbolIcon Symbol=ArrowForward}"
                            LabelPosition="Collapsed"
                            RightTapped="DelayDanmakuClick" />
                    </CommandBar>

                    <CommandBar
                        controls:DockPanel.Dock="Right"
                        DefaultLabelPosition="Collapsed"
                        OverflowButtonVisibility="Collapsed"
                        Visibility="{x:Bind local:C.ToVisibility(Vm.EnableWebView2), Mode=OneWay}">
                        <AppBarButton
                            x:Uid="/MainPanel/VideosButton"
                            Icon="{markup:SymbolIcon Symbol=Video}"
                            Visibility="{x:Bind local:C.IsMultipleToVisibility(WebView.Videos), Mode=OneWay}">
                            <AppBarButton.Flyout>
                                <local:RadioMenuFlyout
                                    ItemsSource="{x:Bind WebView.Videos}"
                                    Placement="Top"
                                    SelectedItem="{x:Bind WebView.CurrentVideo, Mode=TwoWay}"
                                    SelectionChanged="CurrentVideoOnSelectionChanged" />
                            </AppBarButton.Flyout>
                        </AppBarButton>
                        <AppBarButton x:Uid="/MainPanel/VolumeButton" ToolTipService.ToolTip="{x:Bind Vm.Volume, Mode=OneWay}">
                            <AppBarButton.Icon>
                                <fluent:SymbolIcon Symbol="{x:Bind local:C.VolumeSymbolSelector(Vm.Mute, Vm.Volume), Mode=OneWay}" />
                            </AppBarButton.Icon>
                            <AppBarButton.Flyout>
                                <Flyout Placement="Top">
                                    <StackPanel>
                                        <!--  IsTabStop="False"防止自动打开后获得焦点  -->
                                        <Slider
                                            MinHeight="100"
                                            HorizontalAlignment="Center"
                                            IsEnabled="{x:Bind local:C.Negation(Vm.Mute), Mode=OneWay}"
                                            IsTabStop="False"
                                            Maximum="100"
                                            Minimum="0"
                                            Orientation="Vertical"
                                            StepFrequency="1"
                                            Value="{x:Bind Vm.Volume, Mode=TwoWay}" />
                                        <AppBarButton
                                            x:Uid="/MainPanel/MuteButton"
                                            Width="40"
                                            HorizontalAlignment="Center"
                                            Click="MuteOnClick"
                                            IsTabStop="False"
                                            LabelPosition="Collapsed">
                                            <AppBarButton.Icon>
                                                <fluent:SymbolIcon Symbol="{x:Bind local:C.VolumeSymbolSelector(Vm.Mute, Vm.Volume), Mode=OneWay}" />
                                            </AppBarButton.Icon>
                                        </AppBarButton>
                                    </StackPanel>
                                </Flyout>
                            </AppBarButton.Flyout>
                            <AppBarButton.KeyboardAccelerators>
                                <KeyboardAccelerator Key="Down" Invoked="VolumeDownClick" />
                                <KeyboardAccelerator Key="Up" Invoked="VolumeUpClick" />
                            </AppBarButton.KeyboardAccelerators>
                        </AppBarButton>
                        <AppBarButton
                            x:Uid="/MainPanel/SyncButton"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="LoadSyncOnClick"
                            Icon="{markup:SymbolIcon Symbol=ArrowSync}" />
                        <AppBarButton
                            x:Uid="/MainPanel/LockWebView2Button"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="LockWebView2OnClick">
                            <AppBarButton.Icon>
                                <fluent:SymbolIcon Symbol="{x:Bind local:C.SymbolSelector(Vm.LockWebView2, common:Symbol.CursorHoverOff, common:Symbol.CursorHover), Mode=OneWay}" />
                            </AppBarButton.Icon>
                        </AppBarButton>
                        <AppBarButton
                            x:Uid="/MainPanel/FullScreenButton"
                            local:TapHelper.DoubleTappedDisabled="True"
                            Click="FullScreenOnClick">
                            <AppBarButton.Icon>
                                <fluent:SymbolIcon Symbol="{x:Bind local:C.SymbolSelector(Vm.FullScreen, common:Symbol.ArrowMinimize, common:Symbol.ArrowMaximize), Mode=OneWay}" />
                            </AppBarButton.Icon>
                        </AppBarButton>
                    </CommandBar>
                    <CommandBar
                        controls:DockPanel.Dock="Right"
                        DefaultLabelPosition="Collapsed"
                        OverflowButtonVisibility="Collapsed">
                        <AppBarButton x:Uid="/MainPanel/PlaybackRateButton" ToolTipService.ToolTip="{x:Bind local:C.StringFormatter(Vm.PlaybackRate, '{0:0.0#}'), Mode=OneWay}">
                            <AppBarButton.Icon>
                                <fluent:SymbolIcon Symbol="{x:Bind local:C.PlaybackRateSymbolSelector(Vm.PlaybackRate), Mode=OneWay}" />
                            </AppBarButton.Icon>
                            <AppBarButton.Flyout>
                                <local:RadioMenuFlyout
                                    Formatter="{}{0:0.0#}"
                                    ItemsSource="{x:Bind _playbackRates}"
                                    Placement="Top"
                                    SelectedItem="{x:Bind Vm.PlaybackRate, Mode=TwoWay}"
                                    SelectionChanged="PlaybackRateOnSelectionChanged" />
                            </AppBarButton.Flyout>
                        </AppBarButton>
                    </CommandBar>
                    <ProgressRing controls:DockPanel.Dock="Right" IsActive="{x:Bind WebView.IsLoading, Mode=OneWay}" />
                </controls:DockPanel>
                <local:VideoSlider
                    Margin="10,0"
                    VerticalAlignment="Center"
                    controls:DockPanel.Dock="Bottom"
                    local:TapHelper.DoubleTappedDisabled="True"
                    IsTabStop="False"
                    Maximum="{x:Bind Vm.TotalTime.TotalSeconds, Mode=OneWay}"
                    Minimum="0"
                    SliderManipulationCompleted="VideoSliderOnSliderManipulationCompleted"
                    StepFrequency="0.1"
                    ThumbToolTipValueConverter="{StaticResource DoubleToTimeTextConverter}"
                    UserValue="{x:Bind local:C.ToSecondDouble(Vm.Time), BindBack=SecondToTimeSpan, Mode=TwoWay}"
                    UserValueChangedByManipulation="VideoSliderOnUserValueChangedByManipulation" />
            </controls:DockPanel>
        </Grid>
    </local:CollapsibleArea>
    <local:SettingsDialog x:Name="DialogSetting" Grid.Row="0" />
    <local:InputDialog x:Name="DialogInput" Grid.Row="0" />
    <local:RemoteDialog
        x:Name="DialogRemote"
        Grid.Row="0"
        x:FieldModifier="public" />
</Grid>
